<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaptas - Prospectador de Candidatos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 25px; text-align: center; }
        .content { padding: 30px; }
        .search-section { background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; margin-bottom: 30px; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #2c3e50; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .form-grid, .form-grid-3 { grid-template-columns: 1fr; } }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; background: white; }
        input:focus, select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .btn { background: #3498db; color: white; border: none; padding: 14px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; width: 100%; }
        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .loading { display: none; text-align: center; color: #3498db; font-weight: 600; padding: 15px; background: #ebf5fb; border-radius: 8px; margin: 15px 0; }
        .results-section { background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .results-count { background: #2ecc71; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .export-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s; }
        .export-btn:hover { background: #219a52; }
        .contacts-table { width: 100%; background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e9ecef; }
        .table-header { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; background: #2c3e50; color: white; font-weight: 600; padding: 15px 20px; }
        .table-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; padding: 15px 20px; border-bottom: 1px solid #ecf0f1; transition: background 0.3s; }
        .table-row:hover { background: #f8f9fa; }
        .table-row:last-child { border-bottom: none; }
        .table-cell { padding: 5px 0; display: flex; align-items: center; }
        .linkedin-cell a { color: #0077b5; text-decoration: none; }
        .linkedin-cell a:hover { text-decoration: underline; }
        .empty-state { text-align: center; color: #7f8c8d; padding: 40px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 20px; }
        .error { background: #e74c3c; color: white; padding: 12px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: 600; }
        .info-text { font-size: 12px; color: #7f8c8d; margin-top: 5px; font-style: italic; }
        .aesthetic-field { background: #f8f9fa; border: 2px dashed #bdc3c7; }
        .fields-section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db; }
        .section-subtitle { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #2c3e50; }
        .search-preview { background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3498db; }
        .search-preview h4 { margin: 0 0 8px 0; color: #2c3e50; }
        .search-preview code { background: white; padding: 8px 12px; border-radius: 4px; font-family: monospace; display: block; }
        .filter-controls { background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #e74c3c; }
        .filter-controls label { display: inline-block; margin-right: 15px; font-weight: 600; }
        .filter-select { width: auto; display: inline-block; margin-right: 20px; min-width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://kaptasglobal.io/wp-content/uploads/2024/01/kaptas-logobranco.png" style="width: 200px; height: 100px;" alt="Kaptas">
            <h2>Prospectador de Candidatos</h2>
            <p>Encontre candidatos ideais baseado nos crit√©rios da vaga</p>
        </div>

        <div class="content">
            <div class="search-section">
                <div class="section-title">üîç Crit√©rios de Busca</div>
                
                <form id="prospectForm">
                    <!-- CAMPOS PARA API (APENAS OS QUE FUNCIONAM) -->
                    <div class="fields-section">
                        <div class="section-subtitle">Crit√©rios de Busca (Enviados para a API)</div>
                        
                        <!-- Filtros de Palavra-chave Separados -->
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label for="cargo">Cargo *:</label>
                                <select id="cargo" name="cargo" required>
                                    <option value="">Selecione um cargo</option>
                                    <option value="Software Engineer">Software Engineer</option>
                                    <option value="Senior Software Engineer">Senior Software Engineer</option>
                                    <option value="Full Stack Developer">Full Stack Developer</option>
                                    <option value="Frontend Developer">Frontend Developer</option>
                                    <option value="Backend Developer">Backend Developer</option>
                                    <option value="DevOps Engineer">DevOps Engineer</option>
                                    <option value="Data Scientist">Data Scientist</option>
                                    <option value="Data Analyst">Data Analyst</option>
                                    <option value="Machine Learning Engineer">Machine Learning Engineer</option>
                                    <option value="Product Manager">Product Manager</option>
                                    <option value="Project Manager">Project Manager</option>
                                    <option value="Scrum Master">Scrum Master</option>
                                    <option value="UX/UI Designer">UX/UI Designer</option>
                                    <option value="Product Designer">Product Designer</option>
                                    <option value="Marketing Manager">Marketing Manager</option>
                                    <option value="Digital Marketing Specialist">Digital Marketing Specialist</option>
                                    <option value="Sales Manager">Sales Manager</option>
                                    <option value="Account Executive">Account Executive</option>
                                    <option value="Business Development Manager">Business Development Manager</option>
                                    <option value="Customer Success Manager">Customer Success Manager</option>
                                    <option value="HR Manager">HR Manager</option>
                                    <option value="Recruiter">Recruiter</option>
                                    <option value="Financial Analyst">Financial Analyst</option>
                                    <option value="Operations Manager">Operations Manager</option>
                                    <option value="CTO">CTO</option>
                                    <option value="CEO">CEO</option>
                                    <option value="CFO">CFO</option>
                                    <option value="COO">COO</option>
                                </select>
                                <div class="info-text">Selecione o cargo desejado</div>
                            </div>
                            <div class="form-group">
                                <label for="especialidades">Especialidades:</label>
                                <input type="text" id="especialidades" name="especialidades" 
                                       placeholder="Ex: Python, React, Salesforce">
                                <div class="info-text">Habilidades e especialidades</div>
                            </div>
                            <div class="form-group">
                                <label for="setor">Setor:</label>
                                <input type="text" id="setor" name="setor" 
                                       placeholder="Ex: Tecnologia, Sa√∫de, Educa√ß√£o">
                                <div class="info-text">Setor de atua√ß√£o</div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="tamanho_empresa">Tamanho M√≠nimo da Empresa:</label>
                                <select id="tamanho_empresa" name="tamanho_empresa">
                                    <option value="">Qualquer tamanho</option>
                                    <option value="1,">1+ funcion√°rios</option>
                                    <option value="10,">10+ funcion√°rios</option>
                                    <option value="50,">50+ funcion√°rios</option>
                                    <option value="100,">100+ funcion√°rios</option>
                                    <option value="200,">200+ funcion√°rios</option>
                                    <option value="500,">500+ funcion√°rios</option>
                                    <option value="1000,">1000+ funcion√°rios</option>
                                    <option value="5000,">5000+ funcion√°rios</option>
                                </select>
                                <div class="info-text">N√∫mero m√≠nimo de funcion√°rios</div>
                            </div>

                            <div class="form-group">
                                <label for="localidade">Localidade:</label>
                                <input type="text" id="localidade" name="localidade" 
                                        placeholder="Ex: S√£o Paulo, Rio de Janeiro">
                                <div class="info-text">Digite o estado ou cidade</div>
                            </div>
                        </div>

                        <!-- Preview da busca -->
                        <div class="search-preview">
                            <h4>üîç Busca que ser√° realizada:</h4>
                            <code id="searchPreview">Selecione um cargo para ver a busca</code>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">üöÄ Buscar Candidatos</button>
                    <div class="loading" id="loading">‚è≥ Buscando candidatos...</div>
                </form>
            </div>

            <div class="results-section">
                <div class="section-title">üìä Resultados</div>
                
                <!-- Controles de Filtro -->
                <div class="filter-controls" id="filterControls" style="display: none;">
                    <label for="filterCargo">Filtrar por cargo:</label>
                    <select id="filterCargo" class="filter-select">
                        <option value="">Todos os cargos</option>
                    </select>
                    <span id="filteredCount" style="font-weight: 600; color: #2c3e50;"></span>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Preencha os crit√©rios de busca e clique em "Buscar Candidatos" para come√ßar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentContacts = [];
        let selectedCargo = '';

        // Atualizar preview da busca
        function updateSearchPreview() {
            const cargo = document.getElementById('cargo').value;
            const especialidades = document.getElementById('especialidades').value;
            const setor = document.getElementById('setor').value;
            const localidade = document.getElementById('localidade').value;
            const tamanho = document.getElementById('tamanho_empresa').value;
            
            let preview = '';
            
            if (cargo || especialidades || setor) {
                if (cargo) preview += `Cargo: ${cargo}`;
                if (especialidades) preview += `${preview ? ' | ' : ''}Especialidades: ${especialidades}`;
                if (setor) preview += `${preview ? ' | ' : ''}Setor: ${setor}`;
                
                if (localidade) preview += ` em ${localidade}`;
                if (tamanho) {
                    const minSize = tamanho.replace(',', '');
                    preview += ` | Empresas com ${minSize}+ funcion√°rios`;
                }
            } else {
                preview = 'Selecione um cargo para ver a busca';
            }
            
            document.getElementById('searchPreview').textContent = preview;
        }

        // Filtrar resultados por cargo
        function filterResultsByCargo() {
            const filterCargo = document.getElementById('filterCargo').value;
            const filteredContacts = filterCargo ? 
                currentContacts.filter(contact => contact.title && contact.title.toLowerCase().includes(filterCargo.toLowerCase())) : 
                currentContacts;

            displayFilteredResults(filteredContacts, filterCargo);
        }

        // Exibir resultados filtrados
        function displayFilteredResults(contacts, filterCargo = '') {
            const resultsContainer = document.getElementById('resultsContainer');
            const filteredCount = document.getElementById('filteredCount');

            if (contacts.length === 0) {
                resultsContainer.innerHTML = `<div class="error">‚ùå Nenhum candidato encontrado ${filterCargo ? `para "${filterCargo}"` : ''}</div>`;
                if (filteredCount) filteredCount.textContent = '';
                return;
            }

            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-count">üìä ${contacts.length} candidatos ${filterCargo ? `com cargo "${filterCargo}"` : 'encontrados'}</div>
                    <button class="export-btn" onclick="exportToCSV()">üì• Exportar para CSV</button>
                </div>
                <div class="contacts-table">
                    <div class="table-header">
                        <div>Nome</div><div>Cargo</div><div>Empresa</div><div>Email</div><div>LinkedIn</div>
                    </div>
                    ${contacts.map(contact => `
                        <div class="table-row">
                            <div class="table-cell">${contact.name || 'N/A'}</div>
                            <div class="table-cell">${contact.title || 'N/A'}</div>
                            <div class="table-cell">${contact.company_name || 'N/A'}</div>
                            <div class="table-cell">${contact.email || 'N/A'}</div>
                            <div class="table-cell linkedin-cell">
                                ${contact.linkedin_url ? `<a href="${contact.linkedin_url}" target="_blank">LinkedIn</a>` : 'N/A'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            if (filteredCount) {
                filteredCount.textContent = filterCargo ? 
                    `(${contacts.length} de ${currentContacts.length} candidatos)` : 
                    `(${contacts.length} candidatos totais)`;
            }
        }

        // Popular dropdown de filtro com cargos √∫nicos
        function populateCargoFilter(contacts) {
            const cargoFilter = document.getElementById('filterCargo');
            const cargos = [...new Set(contacts.map(contact => contact.title).filter(Boolean))].sort();
            
            cargoFilter.innerHTML = '<option value="">Todos os cargos</option>';
            cargos.forEach(cargo => {
                cargoFilter.innerHTML += `<option value="${cargo}">${cargo}</option>`;
            });
        }

        // Event listeners para todos os campos
        document.getElementById('cargo').addEventListener('change', updateSearchPreview);
        document.getElementById('especialidades').addEventListener('input', updateSearchPreview);
        document.getElementById('setor').addEventListener('input', updateSearchPreview);
        document.getElementById('localidade').addEventListener('input', updateSearchPreview);
        document.getElementById('tamanho_empresa').addEventListener('change', updateSearchPreview);
        document.getElementById('filterCargo').addEventListener('change', filterResultsByCargo);

        // Form submission
        document.getElementById('prospectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const resultsContainer = document.getElementById('resultsContainer');
            const filterControls = document.getElementById('filterControls');
            
            submitBtn.disabled = true;
            loading.style.display = 'block';
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando...</div>';
            filterControls.style.display = 'none';
            
            try {
                selectedCargo = document.getElementById('cargo').value;
                const especialidades = document.getElementById('especialidades').value;
                const setor = document.getElementById('setor').value;
                
                const requestData = {
                    mode: "candidates",
                    person_titles: selectedCargo ? [selectedCargo] : [],
                    person_locations: document.getElementById('localidade').value ? [document.getElementById('localidade').value + ", Brazil"] : [],
                    organization_num_employees_ranges: document.getElementById('tamanho_empresa').value ? [document.getElementById('tamanho_empresa').value] : [],
                    cargo: selectedCargo || "",
                    especialidades: especialidades || "", 
                    setor: setor || ""
                };

                console.log('Enviando para API:', requestData);
                
                const response = await fetch('https://api.muvecom.com.br/v1/sdr/person-lookup-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                const responseData = await response.json();
                currentContacts = responseData.contacts || [];
                
                // Mostrar controles de filtro se houver resultados
                if (currentContacts.length > 0) {
                    filterControls.style.display = 'block';
                    populateCargoFilter(currentContacts);
                    
                    // Filtrar automaticamente pelo cargo selecionado na busca
                    if (selectedCargo) {
                        document.getElementById('filterCargo').value = selectedCargo;
                    }
                    filterResultsByCargo();
                } else {
                    displayResults(responseData);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                resultsContainer.innerHTML = `<div class="error">‚ùå Erro na busca: ${error.message}</div>`;
            } finally {
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const contacts = data.contacts || [];
            
            if (contacts.length === 0) {
                resultsContainer.innerHTML = `<div class="error">‚ùå Nenhum candidato encontrado</div>`;
                return;
            }

            displayFilteredResults(contacts);
        }

        function exportToCSV() {
            const filterCargo = document.getElementById('filterCargo').value;
            const contactsToExport = filterCargo ? 
                currentContacts.filter(contact => contact.title && contact.title.toLowerCase().includes(filterCargo.toLowerCase())) : 
                currentContacts;

            if (contactsToExport.length === 0) return alert('Nenhum candidato para exportar');
            
            let csv = 'Nome,Cargo,Empresa,Email,LinkedIn\n';
            contactsToExport.forEach(contact => {
                csv += `"${contact.name || 'N/A'}","${contact.title || 'N/A'}","${contact.company_name || 'N/A'}","${contact.email || 'N/A'}","${contact.linkedin_url || 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `candidatos_${filterCargo || 'todos'}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        updateSearchPreview();
    </script>
</body>
</html>
